<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:p="http://primefaces.org/ui">
<f:view transient="false">
    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta charset="UTF-8"/>
        <title>Лабораторная работа 3 - Проверка попадания точки</title>
        <h:outputStylesheet name="styles/reset.css"/>
        <h:outputStylesheet name="styles/main.css"/>
        <script type="text/javascript" src="#{request.contextPath}/scripts/main.js"></script>
    </h:head>
    <body class="main-page">
    <header>
        <div class="container">
            <h1>Проверка попадания точки в область</h1>
        </div>
    </header>
    <main>
        <h:form id="mainForm">
            <div class="two-column-layout">
                <div class="form-section">
                    <h2>Проверка попадания точки</h2>

                    <div class="form-group">
                        <h:outputLabel for="xValue" value="X:"/>
                        <h:selectOneMenu id="xValue" value="#{areaCheckBean.x}"
                                         required="true" requiredMessage="X обязателен для ввода">
                            <f:selectItem itemValue="-4" itemLabel="-4"/>
                            <f:selectItem itemValue="-3" itemLabel="-3"/>
                            <f:selectItem itemValue="-2" itemLabel="-2"/>
                            <f:selectItem itemValue="-1" itemLabel="-1"/>
                            <f:selectItem itemValue="0" itemLabel="0"/>
                            <f:selectItem itemValue="1" itemLabel="1"/>
                            <f:selectItem itemValue="2" itemLabel="2"/>
                            <f:selectItem itemValue="3" itemLabel="3"/>
                            <f:selectItem itemValue="4" itemLabel="4"/>
                            <f:convertNumber integerOnly="true"/>
                            <f:validator validatorId="xValidator"/>
                        </h:selectOneMenu>
                        <h:message for="xValue" styleClass="error-message" id="xValueMessage"/>
                    </div>

                    <div class="form-group">
                        <h:outputLabel for="yValue" value="Y:"/>
                        <h:inputText id="yValue" value="#{areaCheckBean.y}"
                                     required="true" requiredMessage="Y обязателен для ввода"
                                     converter="jakarta.faces.Double">
                            <f:validateDoubleRange minimum="-5.0" maximum="5.0"/>
                        </h:inputText>
                        <p class="hint-text">Диапазон: от -5 до 5</p>
                        <h:message for="yValue" styleClass="error-message" id="yValueMessage"/>
                    </div>

                    <div class="form-group">
                        <h:outputLabel for="rValue" value="R:"/>
                        <p:spinner id="rValue" value="#{areaCheckBean.r}"
                                   min="0.1" max="3.0" stepFactor="0.1"
                                   required="true" requiredMessage="R обязателен"
                                   decimalPlaces="1"
                                   styleClass="r-spinner"/>
                        <p class="hint-text">Шаг изменения: 0.1</p>
                        <h:message for="rValue" styleClass="error-message"/>
                    </div>

                    <h:commandButton id="checkButton" value="Проверить" action="#{areaCheckBean.checkPoint()}" styleClass="btn btn-check">
                        <f:ajax execute="@form" render="mainForm:resultsTable mainForm:yValueMessage mainForm:xValueMessage"
                                oncomplete="setTimeout(function() { if (typeof drawAll === 'function') drawAll(); }, 100);"/>
                    </h:commandButton>
                </div>

                <div class="form-section">
                    <h2>Область</h2>
                    <div class="canvas-container">
                        <canvas id="area" width="400" height="400"></canvas>
                    </div>
                    <p class="canvas-hint">
                        Перемещайте курсор по графику для выбора X и Y. Клик для отправки формы.
                    </p>
                </div>
            </div>

            <script type="text/javascript" src="#{request.contextPath}/scripts/area.js"></script>

            <div class="form-section">
                <h2>История проверок</h2>

                <div class="action-buttons">
                    <h:commandButton id="clearButton"
                                     value="Очистить историю"
                                     action="#{resultsBean.clearResults}"
                                     styleClass="btn btn-danger">
                        <f:ajax render="mainForm:resultsTable"
                                onevent="function(data) { if (data.status === 'success') { setTimeout(function() { if (typeof drawAll === 'function') drawAll(); }, 100); } }"/>
                    </h:commandButton>

                    <h:link outcome="statistics" styleClass="btn btn-statistics">
                        <span class="btn-text">Статистика</span>
                        <span class="btn-arrow">→</span>
                    </h:link>
                </div>

                <h:panelGroup id="resultsTable">
                    <h:dataTable value="#{resultsBean.results}" var="result" styleClass="results-table">
                        <h:column>
                            <f:facet name="header">Время выполнения</f:facet>
                            <h:outputText value="#{result.executionTime}"/>
                        </h:column>
                        <h:column>
                            <f:facet name="header">X</f:facet>
                            <h:outputText value="#{result.x}"/>
                        </h:column>
                        <h:column>
                            <f:facet name="header">Y</f:facet>
                            <h:outputText value="#{result.y}"/>
                        </h:column>
                        <h:column>
                            <f:facet name="header">R</f:facet>
                            <h:outputText value="#{result.r}">
                                <f:convertNumber maxFractionDigits="1"/>
                            </h:outputText>
                        </h:column>
                        <h:column>
                            <f:facet name="header">Попадание</f:facet>
                            <h:outputText value="#{result.hit ? 'Да' : 'Нет'}"/>
                        </h:column>
                    </h:dataTable>
                </h:panelGroup>
            </div>
        </h:form>

        <div style="text-align: center; padding: 20px 0;">
            <h:link outcome="start" styleClass="link">
                ← Вернуться на стартовую страницу
            </h:link>
        </div>
    </main>

    <script>
        var currentR = #{areaCheckBean.r != null ? areaCheckBean.r : 1.0};
        var currentX = #{areaCheckBean.x != null ? areaCheckBean.x : 'null'};
        var currentY = #{areaCheckBean.y != null ? areaCheckBean.y : 'null'};
    </script>

    <h:form id="socketForm">
        <f:websocket channel="resultChannel" scope="application" onmessage="onSocketMessage" connected="true" />
        <p:remoteCommand name="updateTableRC"
                         action="#{resultsBean.refreshData}"
                         update=":mainForm:resultsTable"
                         oncomplete="if(window.drawAll) window.drawAll()" />
    </h:form>

    <script>
        function onSocketMessage(message, channel, event) {
            console.log("CLIENT: Получен WebSocket сигнал:", message);
            if (message === "update") {
                updateTableRC();
            }
        }
    </script>
    </body>
</f:view>
</html>